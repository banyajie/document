#### 本周工作

-   通行证上线
-   3.3.80需求梳理、反讲、排期



#### 3.3.80

###### 通行证赠送功能

>   -   首页入口 - 
>
>       -   赠送按钮、一键领取按钮调整
>       -   服务端判断是否有赠送功能
>
>   -   好友列表  - 老接口 
>
>   -   赠送好友
>
>       -   好友关系校验
>       -   对方数据校验，是否可赠送
>       -   赠送记录（datalog）?
>       -   赠送、支付成功后为好友解锁
>
>   -   赠送通知
>
>       -   im
>
>           
>
>   -   数据需求
>
>       -   赠送记录
>
>       
>
>   -   时间
>
>       -   开发、自测3天
>
>   -   上线
>
>       -   新增接口配置

###### 注销流程优化

>   -   注销老逻辑
>
>       -   绑定关系，注销频率限制、家族长、注销记录
>       -   注销账号、清理session、删除实名认证信息、撤销cp宣言、撤销cp申请
>
>   -   注销申请逻辑修改
>
>       -   事前校验（是否是家族长、）
>       -   注销记录生成（冷静期15天）- ***一个用户同时只有一个有效注销记录***
>       -   返回数据（文案。。。）
>
>   -   上下线逻辑
>
>       -   接收上线kafka，检测是否有有效注销记录，如果有注销申请，撤回注销申请
>       -   私信（你xxxx，欢迎回到xxxx）
>
>   -   注销
>
>       -   定时检查所有有效申请注销记录
>       -   注销账号、清理session、删除实名认证信息、撤销cp宣言、撤销cp申请
>
>       
>
>   -   时间
>
>       -   开发 自测 3 天
>
>   -   上线
>
>       -   db增加字段：state、sid
>       -   上线、

#### 3.3.90



>   -   会员特权二期
>       -   会员礼物（增加一个新的礼物墙。礼物墙接口拉取时判断用户vip等级..）
>       -   
>       -   会员礼物赠送指定礼物获得额外奖励 
>           -   赠送指定礼物，有概率获得额外的奖励（奖励类型：头像框、气泡框、主页特效、进场特效、戒指、礼物卡）（修改支持概率配置）
>           -   一个礼物对应一个奖励，概率为要么获得，要么不获得
>           -   送礼消息支持
>       -   会员商城
>           -   会员商城tab页
>           -   物品类别混合支持
>           -   物品支持判断购买资格（是否可购买、可购买条件标签、不可购买提示、）
>       
>   -   潘多拉魔盒支持
>       -   房主事件
>       
>           -   开播
>           -   关播
>       
>           ```go
>           // topic: nvwa_mediacenter_mediacenter_live_base_event_socialgame
>                           
>           type LiveBaseKafkaMsg struct {
>           	Namespace       string      `json:"namespace"`    // socialgame
>           	Event           string      `json:"event"`		  // live.start（开播）、live.stop（关播）、live.expired（心跳过期关播）
>           	LiveID          string      `json:"live_id"`	  // 直播间ID
>           	Uid             int64       `json:"uid"`          // uid
>               Owner           int64       `json:"owner"`        // 当前主播 uid
>           	LiveType        string      `json:"live_type"`    // 
>           	Title           string      `json:"title"`        //  
>           	Cover           string      `json:"cover"`        //
>           	PubStat         int         `json:"pub_stat"`     // 
>           	Status          int         `json:"status"`       // 
>           	PublishAddr     string      `json:"publish_addr"` //
>           	StreamMixAddr   string      `json:"stream_mix_addr"`
>           	StreamMultiAddr string      `json:"stream_multi_addr"`
>           	StreamLinkAddr  string      `json:"stream_link_addr"`
>           	ShareAddr       string      `json:"share_addr"`
>           	LandScape       int         `json:"landscape"`
>           	StartTime       string      `json:"start_time"`
>           	StopTime        string      `json:"stop_time"`
>           	Longitude       string      `json:"longitude"`
>           	Latitude        string      `json:"latitude"`
>           	Location        string      `json:"location"`
>           	SlotID          int         `json:"slot_id"`  // 当前麦位
>           	SlotNum         int         `json:"slot_num"` // 麦个数
>           	Gender          int         `json:"gender"`   // 房主性别
>           	Extra           interface{} `json:"extra"`    // 扩展信息
>           }
>           ```
>       
>           
>       
>           -   房主转让
>               
>           ```go
>           // topic： nvwa_mediacenter_mediacenter_live_base_owner_set_event_socialgame
>                   
>           type LiveOwnerSeKafkaMsg struct {
>           	Namespace string      `json:"namespace"`
>           	LiveID    string      `json:"live_id"`
>           	RoomID    string      `json:"room_id"`
>           	SlotID    int         `json:"slot_id"`
>               Uid       int64       `json:"uid"`        // 转让前房主uid   
>           	UidSlot   int         `json:"uid_slot"`   // 转让前房主slot
>           	Owner     int64       `json:"owner"`      // 当前房主uid
>           	OwnerSlot int         `json:"owner_slot"` // 当前房主slot
>           	LiveType  string      `json:"live_type"`
>           	Extra     interface{} `json:"extra"`
>           }
>           ```
>       
>           
>       
>   -   会员冰雪节活动
>       -   版本
>       -   入口 - banner
>       -   买一赠一
>       -   财富值加成
>       -   赠送好友
>       
>   -   聊天室挂件
>       
>       -   挂件触发（触发条件）
>           -   触发条件（特定礼物、红包...）可配置、时间可配置（挂件活动时间？？？）
>               -   活动触发场景
>               -   运营配置场景
>           -   挂件广播消息（推）
>           -   挂件信息拉取（拉 ）-  拉取挂件个数
>           -   挂件内容：图片、内容、支持的版本区间（是否可见）、用户是否可见条件、跳转地址.......
>           -   配置后台
>               -   活动时间、图片、内容、是否可见等等
>               -   挂件是否是多业务的 ？？（聊天室 - 游戏房间） -  设计多业务 
>               -   
>       -   基础服务搭建（挂件）
>           -   
>       
>   -   水族馆支持
>
>       -   商城

#### 3.4.00

###### 魅力榜一额外奖励

###### 红包

>   -   入口
>
>       -   礼物墙（聊天室礼物墙） -   客户端控制
>
>   -   购买（礼物红包）
>
>       -   红包额度信息
>           -   价值/额度（人民币、金币）、礼物名称（？）、礼物图片、礼物个数、文案
>       -   支付方式（金币、人民币）
>       -   是否有库存（本期不做） -   库存信息如何展示？？
>       -   人民币支付 - 商品配置
>           -   商品名称、红包个数、对应红包的 （红包配置ID - 所有红包配置在红包基础服务中）
>       -   发红包
>           -   金币方式 - 校验金币余额、扣减金币、发红包
>           -   人民币支付 - 购买订单、支付回调成功后 - 发红包（同步、异步）
>
>   -   红包基础服务
>
>       -   红包配置
>           -   
>       -   发红包
>           -   是否全站广播
>           -   是否使用库存（本期只支持基础逻辑）
>           -   挂件
>       -   领取红包
>           -   
>           -   挂件进度
>       -   红包被领取记录、top5
>       -   红包退款
>           -   倒计时
>           -   关播
>
>       

##### 3.4.60

###### 单人演唱（四天）

> 功能入口
>
> - 创建房间入口切换
> - 房间模式切换（普通语音房 - k歌房模式切换）
>
> 歌曲评分
>
> - 评分功能开启
> - 评分反馈
>
> 正在玩状态
>
> - 大厅用户列表
> - 个人主页
> - 聊天列表页x
> - 私聊
> - 家族
>
> 数据埋点
>
> - 服务端埋点
>   - 每日评级歌曲数量

##### 双人合唱（3天）

> 歌曲
>
> - 是否支持合唱（如果支持合唱原点歌按钮 - 合唱）
> - 
>
> 合唱邀请
>
> - 邀请
> - 邀请弹层（邀请消息、倒计时、是否处理）
> - 处理邀请
>
> 评分
>
> - 

##### KTV房间入口（1天）

> 活跃用户游戏入口
>
> - 入口
> - 快速加入( 跳转扩列页 )
>
> 新用户
>
> - 入口
> - 快速加入















#### 3.4.80

##### 声入人心挑战赛活动

- 入口

  - 扩列banner，商城banner，语音房互动玩法

- 后台

  - 歌单列表页（查询接口，支持时间过滤）

    - 每一期的信息（歌单唯一ID生成？、开始时间、结束时间、操作人、、、、、、、）

    - ```mysql
      -- 歌单数据表
      -- 奖励是否发送完成标记
      CREATE TABLE `rank_song_menu_table` (
        `song_menu_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '歌单ID',
        `operator` varchar(128) DEFAULT '' COMMENT '操作人',
        `award` int(4) NOT NULL DEFAULT '0' COMMENT '奖励是否已发放0：未发放 1：已发放'
        `state` int(4) NOT NULL DEFAULT '0' COMMENT '操作：1：正常 2：删除',
        `start_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '开始时间',
        `end_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '结束时间',
        `create_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        `update_at` datetime NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '',
        PRIMARY KEY (`song_menu_id`),
        KEY `s_time` (`start_time`),
      ) ENGINE=InnoDB AUTO_INCREMENT=1999 DEFAULT CHARSET=utf8mb4;
      
      -- 歌单歌曲信息
      CREATE TABLE `rank_song_list_table` (
        `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        `song_menu_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '歌单ID',
        `seq_num` int(8) unsigned NOT NULL COMMENT '歌曲序号',
        `song_id` varchar(32) DEFAULT '' COMMENT '歌曲ID',
        `song_name` varchar(128) DEFAULT '' COMMENT '歌曲名称',
        `singer_id` varchar(64) DEFAULT '' COMMENT '歌手ID',
        `singer_name` varchar(128) DEFAULT '' COMMENT '歌手姓名',
        `song_type` int(4) unsigned NOT NULL DEFAULT '1' COMMENT '歌曲类型：1-单人 2-合唱',
        `play_point` int(8) unsigned NOT NULL COMMENT '播放点 - 秒',
        `state` int(4) NOT NULL DEFAULT '0' COMMENT '操作：1：正常 2：删除',
        `create_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        `update_at` datetime NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '',
        PRIMARY KEY (`id`),
        KEY `song_menu` (`song_menu_id`,`state`)
      ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
      
      -- 用户打榜数据
      CREATE TABLE `rank_user_data_table` (
        `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        `uid` bigint(20) unsigned NOT NULL COMMENT '用户ID',
        `song_menu_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '歌单ID',
        `song_id` varchar(16) DEFAULT '' COMMENT '歌曲ID',
        `chorus_uid` bigint(20) unsigned NOT NULL COMMENT '合唱人UID',
        `score` int(8) unsigned NOT NULL DEFAULT '0' COMMENT '歌曲评分',
        `score_desc` varchar(8) DEFAULT '' COMMENT '歌曲评级', 
        `play_url` varchar(64) DEFAULT '' COMMENT '播放地址', 
        `state` int(4) NOT NULL DEFAULT '0' COMMENT '操作：1：正常 2：审核通过 3：审核失败',
        `create_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        `update_at` datetime NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '',
        PRIMARY KEY (`id`),
        KEY `uid` (`uid`),
        KEY `song_menu` (`song_menu_id`)
      ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
      
      -- 用户奖励发放记录
      -- 分库分表
      CREATE TABLE `rank_user_award_record` (
        `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        `uid` bigint(20) unsigned NOT NULL COMMENT '用户ID',
        `song_menu_id` bigint(20) unsigned NOT NULL COMMENT '歌单ID',
        `song_id` varchar(16) DEFAULT '' COMMENT '歌曲ID',
        `rank` int(16) unsigned NOT NULL DEFAULT '0' COMMENT '排名',  
        `award_type` int(20) unsigned NOT NULL COMMENT '奖励类型',
        `award_props_id` bigint(20) unsigned NOT NULL COMMENT '奖励物品模板ID'
        `award_num` int(8) unsigned NOT NULL DEFAULT '0' COMMENT '奖励个数',
        `create_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        `update_at` datetime NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '',
        PRIMARY KEY (`id`),
        KEY `uid` (`uid`)
      ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
      
      ```

    - 

  - 歌单添加（添加一期活动、开始时间、结束时间 、、、、、、）

    - 保证歌单有效期不重叠
    - 

  - 歌单删除

    - 

  - 查询当前歌单的歌曲信息

    - 

  - 新增歌曲

    - 合唱？？？
    - 

  - 搜索歌曲信息（id - zego的歌曲ID、歌曲名称）

    - 

  - 用户作品拉取（上传时间过滤、uid过滤、）

    - 

  - 审核用户上传的歌曲

    - 通过、删除
    - 私聊消息
      - 审核通过后，“系统消息”发消息提示：【声入人心】你的作品已通过审核，若单首歌曲排名前二十，可在榜单中点击试听
      - 审核未通过，“系统消息”发消息提示：【声入人心】你的作品未通过审核，存在违规情况，若多次违规，将取消你的打榜资格

- 业务功能

  - 歌曲评分上传

    - 评分上传接口（s s级以上的并且是打榜的歌曲？？？）

    - s 级别可以打榜。不上传歌曲

    - 上传规则

      - 前20名进榜单
      - 上传标准 - ss 级以上才可以上传，上传后审核
      - 每个人每一期最多三首上榜
      - 单人单首歌。最好成绩

    - 全站广播

      - 1、用户打榜歌曲评级为SSS且成为榜一时，会有全站广播

           文案：恭喜XXXXX成为XXX歌曲榜第一名

        2、用户成为某首歌榜一时，本人最高分再次刷新成为榜一时不进行广播

  - 点歌页增加挑战榜tab页

    - 原有结构扩展评分信息( 该歌曲的最高得分 )
    - 

  - 歌单到期奖励发放

    - 每周活动结束后。周四自动发放
      - 

  - 歌单列表拉取（分页。按时间逆序）

    - 活动名称、活动开始时间、结束时间
    - 歌单信息
      - 排行榜20条数据

  - 歌曲榜单

    - 歌曲信息
    - 玩家信息
    - 我的排名

  - 星光殿堂（？？？）

    - 歌单列表











二、涉及的问题：
1、录播有延时
---- 延时不是问题，主播提交上传后，需要人审核。业务能接收的延时分钟级别。
2、录播丢失
---- 业务在审核测屏蔽掉。
3、录播中间确实数据
---- 业务可以接收。
4、录播保留多久时间
---- 可以参考inke，重新传到永久桶中。
5、m3u8转成mp3?
---- 需要转码成mp3，待讨论确认。
6、需要上传的流？
7、业务方时间点
8、业务方行动项
（1）ktv的混流准备好
（2）ktv混流接入录播
（3）处理后的ktv文件永久保存的话，需要找运维李闯开通永久保存到的bucket
（4）接入多媒体的录像高光时刻服务，这里需要协商具体接口，多媒体可能需要兼容







@班亚杰   
1、混流接入录播的接口文档：https://wiki.inkept.cn/pages/viewpage.action?pageId=155777832

2、多媒体的录像高光时刻服务。这个接口需要协调什么：先看看这个接口，后面在这个接口接口上加个字段来处理你们的请求  https://wiki.inkept.cn/pages/viewpage.action?pageId=119192253





